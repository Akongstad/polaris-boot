version: '3'

dotenv: ['polaris-spark-local/.env']

tasks:
  demo-create-catalog-local:
    desc: create local memory quickstart_catalog
    dir: ../polaris
    cmds:
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        catalogs \
        create \
        --storage-type FILE \
        --default-base-location ${DEFAULT_BASE_LOCATION} \
        quickstart_catalog

  demo-create-principal:
    desc: create a principal that has access to manage that catalog
    dir: ../polaris
    cmds:
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        principals \
        create \
        quickstart_user
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        principal-roles \
        create \
        quickstart_user_role
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        catalog-roles \
        create \
        --catalog quickstart_catalog \
        quickstart_catalog_role

  demo-grant-roles:
    desc: we grant the principal the principal role we created, and grant the catalog role the principal role we created.
    cmds:
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        principal-roles \
        grant \
        --principal quickstart_user \
        quickstart_user_role
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        catalog-roles \
        grant \
        --catalog quickstart_catalog \
        --principal-role quickstart_user_role \
        quickstart_catalog_role

  demo-assign-privelege:
    desc: This grants the catalog privileges CATALOG_MANAGE_CONTENT to our catalog role
    dir: ../polaris
    cmds:
      - |
        ./polaris \
        --client-id ${CLIENT_ID} \
        --client-secret ${CLIENT_SECRET} \
        privileges \
        catalog \
        grant \
        --catalog quickstart_catalog \
        --catalog-role quickstart_catalog_role \
        CATALOG_MANAGE_CONTENT

  demo-spark:
    dir: ../spark
    desc: Run spark with polaris catalog file location = spark.sql("DESCRIBE FORMATTED quickstart_table").show(false)
    cmds:
      - |
        ./bin/spark-shell \
        --packages org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.7.1,org.apache.hadoop:hadoop-aws:3.4.0 \
        --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \
        --conf spark.sql.catalog.quickstart_catalog.warehouse=quickstart_catalog \
        --conf spark.sql.catalog.quickstart_catalog.header.X-Iceberg-Access-Delegation=vended-credentials \
        --conf spark.sql.catalog.quickstart_catalog=org.apache.iceberg.spark.SparkCatalog \
        --conf spark.sql.catalog.quickstart_catalog.catalog-impl=org.apache.iceberg.rest.RESTCatalog \
        --conf spark.sql.catalog.quickstart_catalog.uri=http://localhost:8181/api/catalog \
        --conf spark.sql.catalog.quickstart_catalog.credential=${PRINCIPAL_CLIENT_ID}:${PRINCIPAL_CLIENT_SECRET} \
        --conf spark.sql.catalog.quickstart_catalog.scope='PRINCIPAL_ROLE:ALL' \
        --conf spark.sql.catalog.quickstart_catalog.token-refresh-enabled=true \
        --conf spark.sql.catalog.quickstart_catalog.client.region=us-west-2


  activate-venv:
    cmds:
      - source polaris-venv/bin/activate

  bootstrap-env:
    cmds:
      - export $(grep -v '^#' .envs/polaris-demo.env | xargs)

  catalogs-list:
    cmds:
      - ./polaris catalogs list
